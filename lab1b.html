<!-- lab1a.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Lab 1A: Arduino IDE - Evan Leong</title>
    <link href="css/styles.css" rel="stylesheet" />
      <link rel="icon" type="image/x-icon" href="assets/img/profile_photo.jpg" />
      <!-- Font Awesome icons (free version)-->
      <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
      <!-- Google fonts-->
      <link href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:500,700" rel="stylesheet" type="text/css" />
      <link href="https://fonts.googleapis.com/css?family=Muli:400,400i,800,800i" rel="stylesheet" type="text/css" />
      <!-- Core theme CSS (includes Bootstrap)-->
      <link href="css/styles.css" rel="stylesheet" />
      <!-- Mathjax CDN -->
      <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      <!-- Jquery -->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
      <!-- Image Lightboxes-->
      <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
  
    <!-- Add any other necessary links/scripts here -->
</head>
<body id="page-top">
    <!-- Navigation Bar -->
       <!-- Navigation-->
       <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top" id="sideNav">
        <a class="navbar-brand js-scroll-trigger" href="#page-top">
            <span class="d-block d-lg-none">Evan Leong</span>
            <span class="d-none d-lg-block"><img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="assets/img/profile_photo.jpg" alt="..." /></span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse outer " id="navbarResponsive" style = "max-height: 50vh" >
            <div class = "inner">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="index.html">About</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="lab1a.html">Lab 1: Part A</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="lab1b.html">Lab 1: Part B</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="lab2.html">Lab 2: IMU </a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="lab3.html">Lab 3: ToF </a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="lab4.html">Lab 4: Motor Drivers and Open Loop Control</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="lab5.html">Lab 5: Linear PID and Interpolation</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="lab6.html">Lab 6: Orientation PID</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="lab7.html">Lab 7: Kalman Filtering</a></li>
                    <li class="nav-item"><a class="nav-link js-scroll-trigger" href="lab8.html">Lab 8: Stunts!</a>
                </ul>
            </div>
        </div>
    </nav>

      <!-- Lab 1B Section -->
      <section class="resume-section" id="lab1b">
        <div class="resume-section-content">
            <h2 class="mb-5">Lab 1B: Bluetooth Setup</h2>
            <div class="d-flex flex-column flex-md-row justify-content-between mb-5">
                <div class="flex-grow-1">
                    <h3 class="mb-0">Prelab</h3>
                    <div class="subheading mb-3">Environment Setup</div>
                    <p> I already had Python's virtualenv package installed, so I created a new directory for Lab 1, initialized a venv named 'FastRobots_ble', and installed the required packages with pip.</p>
                    <img src="assets/img/lab1/venv.png" alt="virtual environment check" class ="img-fluid mb-3">
                    <div class="subheading mb-3">Codebase</div>
                    <p> BLE stands for Bluetooth Low Energy, a communication protocol for wireless communication between devices that consumes little power. 
                        BLE utilizes the GATT profile, which is a peripheral-central model that defines device interactions. In our codebase, after establishing a Bluetooth connection to the Nano, the functions provided through imports in the 'demo.ipynb' allow us to read, write, and subscribe to characteristics that are advertised by our Nano board. 
                        The Nano runs 'ble_arduino.ino', which contains the RobotCommand class used to parse incoming commands from the laptop client, 
                        and a switch statement (defined in handle_command()) to determine and execute the corresponding commands that we will implement throughout the lab. 
                    </p>
                </div>
                <div class="flex-shrink-0"><span class="text-primary"></span></div>
            </div>
            <div class="d-flex flex-column flex-md-row justify-content-between">
                <div class="flex-grow-1">
                    <h3 class="mb-0">Configuration</h3>
                    <div class="subheading mb-3"> Generate new UUID and update Nano MAC Address </div>
                    <ul> 1. I first installed the ArduinoBLE library and then flashed the Artemis Nano with the demo sketch provided by the lab's codebase. </ul>
                    <ul> 2. The demo sketch printed out the Nano's MAC address which I made sure to left pad with 0s to get a full 12 hex address. I then updated the corresponding variable in the config .yaml file. </ul>
                    <ul> <img src="assets/img/lab1/mac_addr.png" alt="virtual environment check" class = "img-fluid mb-3"></ul>
                    <ul> 3. I then generated a UUID to replace the existing BLE (Bluetooth Low Energy Characteristic) to avoid my computer connecting to other boards and updated this in the .yaml file as well. </ul>
                </div>
                <div class="flex-shrink-0"><span class="text-primary"></span></div>
            </div>
            <div class="d-flex flex-column flex-md-row justify-content-between">
                <div class="flex-grow-1">
                    <h3 class="mb-0">Task 1</h3>
                    <div class="subheading mb-3">Echo</div>
                    <script src="https://gist.github.com/evnleong/16b0096907853902ec386aace1db0272.js"></script>
                    <p> I added code to the Nano's sketch to prepend the string 'Echoing:' and postpending the ':P' emoticon to any received strings read from the TX characteristic.</p>
                    <p> Starting Jupyter Lab, I ran the relevant import statements and then called the Echo command which gave the following output.  </p>
                    <br>
                    <img src="assets/img/lab1/echo_received.png" alt = "echo received" class ="img-fluid mb-3">
                    <br>
                </div>
                <div class="flex-shrink-0"><span class="text-primary"></span></div>
            </div>
            <div class="d-flex flex-column flex-md-row justify-content-between">
                <div class="flex-grow-1">
                    <h3 class="mb-0">Task 2</h3>
                    <div class="subheading mb-3">Send_Three_Floats</div>
                    <script src="https://gist.github.com/evnleong/eb33ede6cdef7e5f52797377ac2eaa30.js"></script>
                    <p>I then added the above code to loop through 3 received characters, append them to an array, and print out the 3 received floats.</p>
                    <img src = "assets/img/lab1/send_3_floats_py.png" alt = "floats sent" class = "img-fluid mb-3"> 
                    <img src = "assets/img/lab1/send_3_floats_received.png" alt = "floats received" class = "img-fluid mb-3"> 
                </div>
                <div class="flex-shrink-0"><span class="text-primary"></span></div>
            </div>
            <div class="d-flex flex-column flex-md-row justify-content-between">
                <div class="flex-grow-1">
                    <h3 class="mb-0">Task 3</h3>
                    <div class="subheading mb-3">Get_Time_Millis</div>
                    <p> I then wrote a new command called GET_TIME_MILLIS that utilizes Arduino's millis() function to get the current program time and uploaded it to the Nano. </p>
                    <script src="https://gist.github.com/evnleong/05ddb4cdddc3ac0047dfaa21e5392ffb.js"></script>
                    <p> This is the resulting output retreived by the Jupyter Notebook:</p>
                    <img src = "assets/img/lab1/get_millis_py.png" class = "img-fluid mb-3">
                </div>
                <div class="flex-shrink-0"><span class="text-primary"></span></div>
            </div>
            <div class="d-flex flex-column flex-md-row justify-content-between">
                <div class="flex-grow-1">
                    <h3 class="mb-0">Task 4 & 5</h3>
                    <div class="subheading mb-3">Notification Handler</div>
                    <p> In my Jupyter Notebook, I used the bleak package's 'start_notify' function to start notifications on the ['RX_STRING'] uuid, and created a callback function called 'notification_handler' to convert the received byte arrays into printable strings.</p>
                    <img src="assets/img/lab1/notification_handler.png" class = "img-fluid mb-3">
                    <p> I then wrote a loop function for my Arduino sketch that would continually send the current program time from the board using the millis() function for 10 seconds. </p>
                    <script src="https://gist.github.com/evnleong/8cc05399087eba1d3ea99694fe51a211.js"></script>
                    <img src = "assets/img/lab1/send_loop_received.png" class = "img-fluid mb-3">
                    <p> To calculate the effective data transfer rate, I modified my callback function to append the received messages to a Python list. I could then measure the length of the list to estimate the effective data transfer rate. </p>
                    <img src = "assets/img/lab1/effective_data_transfer.png" class = "img-fluid mb-3">
                    <p>
                        As shown above, in the 10 seconds, the Nano was able to send 253 messages (as measured by the length of the list), or 25.3 messages per second. 
                        Each transmission consisted of 1 float, or 32 bits (4 bytes) of data. The effective data transfer rate for my method was approximately:
                    </p>
                    <p>
                        \[
                        \frac{253}{10} = 25.3 \, \text{messages/second}
                        \]
                    </p>
                    <p>
                        The total data transfer rate in bytes per second is:
                    </p>
                    <p>
                        \[
                        25.3 \times 4 = 101 \, \text{bytes/second}
                        \]
                
                    </div>
                <div class="flex-shrink-0"><span class="text-primary"></span></div>
            </div>
            <div class="d-flex flex-column flex-md-row justify-content-between">
                <div class="flex-grow-1">
                    <h3 class="mb-0">Task 6</h3>
                    <div class="subheading mb-3">SEND_TIME_DATA</div>
                    <p>For this task, instead of sending time measurements as soon as my board sampled them, I added the following function called 'SEND_TIME_DATA' to my Arduino sketch:</p>
                    <script src="https://gist.github.com/evnleong/107268e948a9cb514ee7161007aa9f73.js"></script>
                    <p> This function utilizes two global variables, 'timearray' and 'datasize'. 'timearray' is an empty float array initialized with size 'datasize' (in this case, my datasize was 50). 
                    The function loops up to the size of 'datasize' to guard against overfilling the array, and fills 'timearray' with 50 sequential time samplings. </p>
                    <p>It then loops through the 'timearray' and sends each reading as a formatted timestamp string.</p>
                    <img src="assets/img/lab1/time_stamps.png" class = "img-fluid mb-3"> 
                    <p>On the Jupyter Notebook, I called the 'SEND_TIME_DATA' function, and initiated the notification handler, 
                    which processed the incoming data and again appended the received data into a Python list which I could measure to ensure all 50 measurements had been sent over.</p>
                    <img src="assets/img/lab1/50_messages_received.png" class = "img-fluid mb-3"> 
                    <p> No lost measurements!</p>
                </div>
                <div class="flex-shrink-0"><span class="text-primary"></span></div>
            </div>

            <div class="d-flex flex-column flex-md-row justify-content-between">
                <div class="flex-grow-1">
                    <h3 class="mb-0">Task 7</h3>
                    <div class="subheading mb-3">GET_TEMP_READINGS</div>
                    <p>In a similar fashion, I created a new function in my Arduino sketch called GET_TEMP_READINGS:</p>
                    <p>This function samples the time and temperature each 50 times, and stored each set of 50 samples into the global 'timearray' and 'temparray' variables.</p>
                    <p>The function then loops through each array and sends the combined temperature readings to my laptop. </p>
                    <script src="https://gist.github.com/evnleong/e260e1715f8adadd2b364d74568f44d3.js"></script>
                    <p> I made a slight modification to the notification handler, prefixing "Temp Reading from Nano" to each temperature reading instead:</p>
                    <img src = "assets/img/lab1/temp_reading_handler.png" class = "img-fluid mb-3">
                    <p>On the Jupyter Notebook, I called the 'SEND_TIME_DATA' function, and initiated the notification handler to get the following results:</p>
                    <img src="assets/img/lab1/temp_readings_received.png" class = "img-fluid mb-3">

                </div>
                <div class="flex-shrink-0"><span class="text-primary"></span></div>
            </div>

            <div class="d-flex flex-column flex-md-row justify-content-between">
                <div class="flex-grow-1">
                    <h3 class="mb-0">Task 8</h3>
                    <div class="subheading mb-3">Discussion</div>
                    <p class = "fw-bold text-secondary"> Discuss the differences between these two methods, the advantages and disadvantages of both and the potential scenarios that you might choose one method over the other.</p>
                    <p>In the first method created in tasks 4 & 5, the speed at which data could be sent was limited by the sampling rate of the millis() and temperature functions. 
                    The board physically cannot transmit the time or temp readings at a rate faster than the functions take to run.
                    However, in the second method, where time and temperature measurements are precalculated and stored in arrays, the most direct limitation of the data transfer speed seems to 
                    be the clock frequency of the Nano's CPU and however many CPU cycles it takes to append a reading from memory to the writeable GATT characteristic.</p>

                    <p>I could see how the first method has an advantage of the data being closer to real-time measurements. In a real-time feedback use case, this would likely be the preferred choice between the two methods as the readings are more closely related to the physical time that the sampling was taken.
                    However, a disadvantage of this method is the decreased speed of data transfer and increased possibility of disruptions when measurements are sent. In a case where we are okay with not receiving immediate feedback from our peripheral device, and we want to instead just need to analyze actions of the bot after they have taken place, the second method might be a more reliable and faster choice.
                    A downside to this method however is the increased RAM utilization by creating extra data structures to hold measurements before sending them to the central device.

                    <p class = "fw-bold text-secondary">How “quickly” can the second method record data?</p>

                    <p>
                        The time taken to send the 50 messages was calculated using the recorded time difference between the first and last sample: 64 milliseconds. 
                        Assuming this rate remains constant, the estimated message transfer speed of the Nano with this method is approximately 
                        \( \frac{50}{0.064} \approx 781 \) messages per second. 
                        Sending just one 4-byte float, this results in an effective data transfer speed of:
                    </p>
                    <p>
                        \[
                        781 \times 4 = 3,124 \text{ bytes/second}
                        \]
                    </p>
                    <p class = "fw-bold text-secondary">The Artemis board has 384 kB of RAM. Approximately how much data can you store to send without running out of memory?</p>
                    If the Artemis board has 384 kB of RAM, and we stored each value as a float, which each comprised of 4 bytes, we could theoretically store at most 96,000 total floats, or 48,000 total timestamp and temperature reading pairs before the board ran out of memory. 
                    </p>

                </div>
                <div class="flex-shrink-0"><span class="text-primary"></span></div>
            </div>

            <div class="d-flex flex-column flex-md-row justify-content-between">
                <div class="flex-grow-1">
                    <h3 class="mb-0">Lab 1B Discussion</h3>
                    <p>In this lab, I learned how to establish a BLE connection between my laptop and the Artemis Nano board, as well as how to create a notification handler to listen to changes on a specific GATT characteristic. </p>
                    <p>I initially struggled with implementing the notification handler and deciphering its parameters, but reading the provided lab text in the Jupyter Notebook was really helpful in understanding its implementation.</p>
                </div>
                <div class="flex-shrink-0"><span class="text-primary"></span></div>
            </div>
            
        </div>
    </section>

    

    
</body>
</html>
